{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container py-4">

  <!-- Display messages once per page -->
  {% if messages %}
    <div class="mb-3">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold"><i class="bi bi-kanban"></i> Project Detail</h2>
    <a href="{% url 'projectDetail' project.id %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Back
    </a>
  </div>

  <!-- Project Info -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">Project Information</div>
    <div class="card-body">
      <p><strong>Title:</strong> {{ project.title }}</p>
      <p><strong>Description:</strong> {{ project.description|default:"No description" }}</p>
      <p><strong>Planned Start:</strong> {{ project.plannedStartDate }}</p>
      <p><strong>Planned End:</strong> {{ project.plannedEndDate }}</p>
      <p><strong>Student:</strong> {{ student.fullName }}</p>
    </div>
  </div>

  <!-- Tasks & Submissions -->
  {% if tasks %}
  <div class="card mb-4">
    <div class="card-header bg-info text-white">Tasks & Submissions</div>
    <div class="card-body table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Task</th>
            <th>Progress</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for task in tasks %}
            {% with task.updates.all as updates %}
              {% if updates %}
                {% for update in updates %}
                  <tr>
                    <td>{{ task.title }}</td>
                    <td>{{ update.progressPercent|default:0 }}%</td>
                    <td>
                      <span class="badge 
                        {% if update.status == 'approved' %}bg-success
                        {% elif update.status == 'rejected' %}bg-danger
                        {% elif update.status == 'submitted' %}bg-warning text-dark
                        {% else %}bg-secondary{% endif %}">
                        {{ update.status|title }}
                      </span>
                    </td>
                    <td>
                      <button class="btn btn-sm btn-primary"
                              data-bs-toggle="modal"
                              data-bs-target="#taskModal{{ update.id }}">
                        View Submission
                      </button>
                    </td>
                  </tr>

                  <!-- Review Modal -->
                  <div class="modal fade" id="taskModal{{ update.id }}" tabindex="-1"
                       aria-labelledby="taskModalLabel{{ update.id }}" aria-hidden="true">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <form method="POST" action="{% url 'reviewTaskUpdate' update.id %}">
                          {% csrf_token %}
                          <div class="modal-header">
                            <h5 class="modal-title" id="taskModalLabel{{ update.id }}">
                              Review Task: {{ task.title }} - {{ update.student.fullName }}
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                          </div>
                          <div class="modal-body">
                            {% if update.proof %}
                              <p><strong>Proof:</strong></p>
                              <a href="{{ update.proof.url }}" target="_blank" class="btn btn-sm btn-info mb-3">
                                View File
                              </a>
                            {% else %}
                              <p class="text-muted">No proof uploaded yet.</p>
                            {% endif %}

                            <div class="mb-3">
                              <label>Status</label>
                              <select name="status" class="form-select" required>
                                <option value="approved" {% if update.status == 'approved' %}selected{% endif %}>Approve ‚úÖ</option>
                                <option value="rejected" {% if update.status == 'rejected' %}selected{% endif %}>Reject ‚ùå</option>
                                <option value="submitted" {% if update.status == 'submitted' %}selected{% endif %}>Submitted ‚è≥</option>
                                <option value="pending" {% if update.status == 'pending' %}selected{% endif %}>Pending üïí</option>
                              </select>
                            </div>

                            <div class="mb-3">
                              <label>Progress (%)</label>
                              <input type="number" name="progressPercent" class="form-control"
                                     min="0" max="100"
                                     value="{{ update.progressPercent|default:0 }}">
                            </div>

                            <div class="mb-3">
                              <label>Comments / Feedback</label>
                              <textarea name="comments" class="form-control" rows="3">{{ update.comments }}</textarea>
                            </div>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-success">Submit Review</button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              {% else %}
                <tr>
                  <td>{{ task.title }}</td>
                  <td>0%</td>
                  <td><span class="badge bg-secondary">No submissions</span></td>
                  <td>-</td>
                </tr>
              {% endif %}
            {% endwith %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% else %}
    <div class="alert alert-info">No tasks available for this project yet.</div>
  {% endif %}

</div>
{% endblock %}
